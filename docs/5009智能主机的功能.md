## V5009智能主机的功能

V5009主机监控并维护连接所有模块的状态，包括U位标签信息，灯光状态，温湿度信息，防拆信息; 根据状态变化触发上传信息到上位机(数据中间件);可以通过http_json api,web界面和配置文件来做设置; 有方便的自动化流程。

### 1. V5009智能主机的REST API.
1.获取V5009智能主机连接的所有模块的u位的状态，标签信息，防拆信息 。
    - API: /status
    - 方法: GET
    - 输出示例:
2.获取V5009智能主机灯光状态
    - API: /light
    - 方法: GET
3.获取温湿度状态 
    - API: /temp
    - 方法: GET
4.设置灯光状态
    - API: /set-light
    - 方法: POST
5. 设置灯闪频率
    - API: /blink-freq
    - 方法: POST
6. 注册上位机的地址
    - API: /register
    - 方法: POST
7. 注销上位机的地址
    - API: /cancel
    - 方法: POST
8. 解除防拆告警
    - API: /cancel-alert
    - 方法: POST

1. http_json形式的api:
    - get:获取主机连接的所有模块的u位的状态，标签信息，防拆信息
        + uri: http://<host:port>/status
        ```

        ```
    - get:获取灯光状态
        + uri:http://<host:port>/light
    - get:获取温湿度状态 
        + uri:http://<host:port>/temp
    - post:设置灯光状态
        + uri:http://<host:port>/set-light
    - Post:设置灯闪频率
        + uri:http://<host:port>/blink-freq
    - Post:注册上位机的地址(中间件的地址)
        + uri:http://<host:port>/register
    - Post:注销上位机的地址(中间件的地址)
        + uri:http://<host:port>/cancel
    - Post:解除防拆告警
        + uri:http://<host:port>/register

2. V5009智能主机主动上传功能：
- 心跳:每隔一定时间(默认20s)向上位机（中间件）推送心跳。
- 标签,模块上下线：当标签或模块有上下线变化时，主动触发推送当前状态信息
- 温湿度：当连接的温湿度模块监测到变化时，上传温湿度信息

3. web界面：
- 设置V5009智能主机的网络参数，和重置密码。

4. 改变默认设置
- 模块数量
- 模块U位数量
- 温湿度个数
- 心跳间隔时间
- 与上位机通信超时时间
- 灯光颜色限制:可以开启全部灯光或允许部分灯光状态可设置
- 上位机的地址: 如果没有设置，则不能开启主动推送动能。

5. 自动流程
- 根据温湿度模块数量的设置，开机自动初始化温湿度模块
- 开机时恢复上次运行时的U位灯光状态
- 当模块重新上线时恢复掉线前U位灯光状态
- 如果上位机已配置，开机时主动上传一次所有的状态

未来可以优化的方向：
- 大部分设置可以通过API，和web界面完成
- 设置完可以即时生效不间断运行
- 针孔按钮短按，长按分别对应重启和恢复出厂设置功能。
- 与上位机通过gRPC协议通信

<!-- - 将程序与系统打包成镜象文件，方便生产 -->

## 数据中间件的功能

数据中间件独立运行，收集并缓存所有的智能主机的所有模块，标签的状态，以及温湿度，防拆信息，灯光状态; 接受心跳并维护智能主机的在线状态.提供http_json格式api。提供标签,模块,机器变动时主动上传功能。提供日志功能。
1. http_json API:
    - GET: 获取所有模块的状态
    - POST: 改变某U位的灯光状态
    - POST: 解除某U位的防拆报警
    - POST: 将自己注册为智能主机的上位机
2. 主动上传：
    - 智能主机上下线: 上传相关智能主机信息
    - 模块上下线时: 上传对应模块信息
    - u位上下线: 上传对应的模块信息
    - 防拆报警触发时，上传对应模块的信息。
    - 定时上传温湿度信息
3. 可以通过配置文件做的设置：
    - 模块的地址列表
    - BS平台的地址和端口
    - 自身的对外连接IP,端口
    - 智能主机心跳超时时限：超过多少秒没收到心跳就判断智能主机离线
  