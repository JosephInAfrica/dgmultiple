## V5009智能主机的功能

V5009主机监控并维护连接所有模块的状态，包括U位标签信息，灯光状态，温湿度信息，防拆信息; 根据状态变化触发上传信息到上位机(数据中间件);可以通过http_json api,web界面和配置文件来做设置; 有方便的自动化流程。

### 1. V5009智能主机的REST API.

1.获取V5009智能主机连接的所有模块的u位的状态，标签信息，防拆信息 。
- API: /status
- 方法: GET
- 输出示例:
```
[
  {
    "status": [
      {
        "index": 48,
        "tag": "04E93431"
      },
      {
        "index": 12,
        "tag": "F3F85EC2"
      }
    ],
    "u_count": 52,
    "alert": [
      
    ],
    "version": "0204",
    "address": 1,
    "module_id": "3771057631",
    "module_amount": 9
  }
]
```

- 解释:
  + 每组数据代表一条模块的信息。
  + 字段status代表标签在线状态。其中index代表u位序号，tag代表标签码。
  + 字段u_count代表每条模块的标签数量。
  + 字段alert 代表正在报警的标签序号。
  + 字段module_id代表模块的id.
  + 字段module_amount代表模块的节数.

2.获取V5009智能主机所连接模块的灯光状态
- API: /light
- 方法: GET
- 输出示例:
```
[
    {
    "module_id": "226393781",
    "light_status": [
      {
        "index": 1,
        "light": 2
      },
      {
        "index": 2,
        "light": 1
      },
      {
        "index": 3,
        "light": 1
      }
]
```

- 解释：
  + 每组数据代表一条模块上的U位的灯光信息。
  + 字段module_id代表模块的id.
  + 字段light_status代表这组模块的灯光状态
    * index代表U位序号
    * light代表灯光编号.共15种灯光状态，从0-14分别代表：0 灭灯 1 红 2 紫 3 黄 4 绿 5 青 6 蓝 7 白 8 红闪烁 9 紫闪烁 10 黄闪烁 11 绿闪烁 12 青闪烁 13 蓝闪烁 14 白闪烁 

3.获取V5009智能主机所连接的温湿度状态 
- API: /temp
- 方法: GET
- 输出示例:
```
[
  {
    "module_id": "3771057631",
    "temp_hum": [
      {
        "index": 10,
        "temp": "31.40",
        "hum": "30.62"
      },
      {
        "index": 11,
        "temp": "30.71",
        "hum": "31.59"
      },
      {
        "index": 12,
        "temp": "30.71",
        "hum": "31.59"
      }
    ]
  }
]
```

- 解释:
  + 字段module_id代表模块的id.
  + 字段temp_hum代表标签连接的温湿度模块收集到的信息。每组数据代表一个温湿度模块的信息。
    * index代表温湿度模块的号码
    * temp代表温度，单位:摄氏度
    * hum代表湿度，单位:1%

4.设置灯光状态
- API: /set-light
- 方法: POST
- 输入示例：`{"module_id":"3771057631","index":19,"light_code":2}`
- 返回值：`{"status":"ok"}` ;`{"status":"failed","reason":"module 3771057631 does not exists"}`
- 解释: module_id代表要设置模块的id, index代表U位序号,light_code代表灯光的代码。如果id对应模块在线，序号和灯光号码都有效，则会返回 "status":"ok"代表设置成功；否则会返回"status":"failed","reason":"<设置失败的原因>"

5. 设置U位灯光闪烁的频率
- API: /blink-freq
- 方法: POST
- 输入示例: `{"module_id":"3771057631","blink_period":0.5}` 
- 返回值：`{"status":"ok"}`
- 解释：示例的意思是将id为3771057631的模块闪烁周期设为0.5秒。其中有效闪烁周期是0.5-3秒。

6. 注册上位机的地址
- API: /register
- 方法: POST
- 输入示例：`{"host":"123.123.123.123:8080"}` 
- 返回值:`{"status":"ok"}`
- 解释：将指定的<ip:port>注册为接收消推送的上位机。

7. 注销上位机的地址
- API: /deregister
- 方法: POST
- 输入示例：`{"host":"123.123.123.123:8080"}` 、
- 返回值:`{"status":"ok"}` 
- 解释：从上位机中注销<ip:port>。如果给的ip:port组合不是上位机，也不会报错。

8. 注销所有上位机地址
- API: /deregiseter-all
- 方法：POST
- 输入:空值
- 返回:`{"status":"ok"}`
- 解释: 将注销所有的上位机，不再主动推送。

9. 解除防拆告警
- API: /cancel-alert
- 方法: POST
- 输入示例：`{"module_id":"3771057631","index":30}`  解除指定id的模块30U的报警。
- 返回:`{"status":"ok"}`
- 解释：module_id和index分别代表模块id和U位序号。如果指定的U位能访问到，则会取消报警(如果指定U位没有报警，也不会报错)；否则会报错。

10. 设置智能主机
- API：/config
- 方法:POST
- 
- 输入示例：`{"ip":"192.168.0.71",}`


### 2. V5009智能主机主动上传功能：
1. 心跳:每隔一定时间(默认20s)向上位机（中间件）推送心跳。
- 推送目地地址:`http:<上位机ip:port/heartbeat>`
- 数据示例：`{"heartbeat":"192.168.0.20"}` 
- 解释:推送本机的ip。

2. 标签,模块上下线：当标签或模块有上下线变化时，主动触发推送当前状态信息。
- 推送目地地址:`http:<上位机ip:port/status>`
- 数据示例：
```
[
  {
    "status": [
      {
        "index": 48,
        "tag": "04E93431"
      },
      {
        "index": 12,
        "tag": "F3F85EC2"
      }
    ],
    "u_count": 52,
    "alert": [12,13],
    "module_id": "3771057631",
    "module_amount": 9
  }
]

```

- 解释：推送主机连接所有模块的当前信息。与GET /status 得到的信息一样。

3. 温湿度：当连接的温湿度模块监测到变化时，上传温湿度信息
- 推送目地地址:`http:<上位机ip:port/temp>`
- 数据示例：
```
[
  {
    "module_id": "3771057631",
    "temp_hum": [
      {
        "index": 10,
        "temp": 31.40,
        "hum": 30.62
      },
      {
        "index": 11,
        "temp": 30.71,
        "hum": 31.59
      },
      {
        "index": 12,
        "temp": 30.71,
        "hum": 31.59
      }
    ]
  }
]
```
- 解释:推送V5009智能主机连接所有模块的当前信息。与GET /temp 得到的信息一样。

### 3. 自动流程
- 开机时加载上次运行时的U位灯光状态
- 当模块重新上线时恢复掉线前U位灯光状态
- 开机时主动向上位机上传一次U位状态，温湿度状态和灯光状态

### 4. 设置：V5009的所有配置都可以通过web界面来设置。
- 初始状态：
  + 模块数量
  + U位数量
  + 温湿度个数
- 功能配置：
  -心跳间隔时间
  - 与上位机通信超时时间
  - 上位机的地址: 如果没有设置，则不能开启主动推送动能。
- 网络参数
  - IP地址，子网掩码，网关
- 密码设置
  - 可以重置用户密码。初始密码为admin。用户名一直是admin不可修改。

<!-- - 根据温湿度模块数量的设置，开机自动初始化温湿度模块 -->




未来可以优化的方向：
- 大部分设置可以通过API，和web界面完成
- 设置完可以即时生效不间断运行
- 针孔按钮短按，长按分别对应重启和恢复出厂设置功能。
- 与上位机通过gRPC协议通信

<!-- - 将程序与系统打包成镜象文件，方便生产 -->

## 数据中间件的功能

数据中间件独立运行，收集并缓存所有的智能主机的所有模块，标签的状态，以及温湿度，防拆信息，灯光状态; 接受心跳并维护智能主机的在线状态.提供http_json格式api。提供标签,模块,机器变动时主动上传功能。提供日志功能。
1. http_json API:
    - GET: 获取所有模块的状态
    - POST: 改变某U位的灯光状态
    - POST: 解除某U位的防拆报警
    - POST: 将自己注册为智能主机的上位机
2. 主动上传：
    - 智能主机上下线: 上传相关智能主机信息
    - 模块上下线时: 上传对应模块信息
    - u位上下线: 上传对应的模块信息
    - 防拆报警触发时，上传对应模块的信息。
    - 定时上传温湿度信息
3. 可以通过配置文件做的设置：
    - 模块的地址列表
    - BS平台的地址和端口
    - 自身的对外连接IP,端口
    - 智能主机心跳超时时限：超过多少秒没收到心跳就判断智能主机离线
  